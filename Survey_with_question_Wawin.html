<!DOCTYPE html>
<html>
<head>
  <title>Canada North/South Survey</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { height: 500px; margin-top: 15px; }
    .question { margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    .question h3 { margin: 0 0 10px; }
  </style>
</head>
<body>
  <h2>Survey: Identify Locations in Canada</h2>
  <p>Please click exactly 3 points on the map for each of the following categories.</p>

  <form id="surveyForm">
    <!-- Four Questions -->
    <div class="question">
      <h3>1. Identify three locations that are definitely in Canada's <b>North</b></h3>
      <input type="hidden" name="north" id="north">
      <ul id="north-list"></ul>
    </div>

    <div class="question">
      <h3>2. Identify three locations that are definitely in Canada's <b>South</b></h3>
      <input type="hidden" name="south" id="south">
      <ul id="south-list"></ul>
    </div>

    <div class="question">
      <h3>3. Identify three locations that are in the <b>South but close to its northern limit</b></h3>
      <input type="hidden" name="southLimit" id="southLimit">
      <ul id="southLimit-list"></ul>
    </div>

    <div class="question">
      <h3>4. Identify three locations that are in the <b>North but close to its southern limit</b></h3>
      <input type="hidden" name="northLimit" id="northLimit">
      <ul id="northLimit-list"></ul>
    </div>

    <button type="submit">Submit Survey</button>
  </form>

  <div id="map"></div>

  <script>
    // Setup Leaflet map
    var map = L.map('map').setView([60, -95], 4); // Center over Canada
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Categories
    const categories = {
      north: { color: "blue", max: 3, points: [], markers: [] },
      south: { color: "green", max: 3, points: [], markers: [] },
      southLimit: { color: "orange", max: 3, points: [], markers: [] },
      northLimit: { color: "red", max: 3, points: [], markers: [] }
    };

    // Current active category (default none until user selects)
    let activeCategory = null;

    // Handle map clicks
    map.on('click', function(e) {
      if (!activeCategory) {
        alert("Please select a question to answer first by clicking its section.");
        return;
      }

      let cat = categories[activeCategory];
      if (cat.points.length >= cat.max) {
        alert("You already selected 3 points for " + activeCategory);
        return;
      }

      // Add marker
      let marker = L.marker(e.latlng, { draggable: false })
        .bindPopup(activeCategory + ": " + e.latlng.lat.toFixed(4) + ", " + e.latlng.lng.toFixed(4))
        .addTo(map);

      // Save point
      cat.points.push([e.latlng.lat, e.latlng.lng]);
      cat.markers.push(marker);

      // Update hidden input + list
      document.getElementById(activeCategory).value = JSON.stringify(cat.points);
      let li = document.createElement("li");
      li.textContent = e.latlng.lat.toFixed(4) + ", " + e.latlng.lng.toFixed(4);
      document.getElementById(activeCategory + "-list").appendChild(li);
    });

    // Allow selecting a category by clicking on its box
    document.querySelectorAll(".question").forEach(div => {
      div.addEventListener("click", () => {
        document.querySelectorAll(".question").forEach(d => d.style.background = "#fff");
        div.style.background = "#f0f8ff";
        activeCategory = div.querySelector("input").id;
      });
    });

    // Handle form submit
      document.getElementById("surveyForm").onsubmit = function(e) {
    e.preventDefault();

    // Check all categories have 3 points
    for (let key in categories) {
      if (categories[key].points.length !== 3) {
        alert("Please select 3 points for " + key + " before submitting.");
        return;
      }
    }

    // Package the data
    let data = {
      north: categories.north.points,
      south: categories.south.points,
      southLimit: categories.southLimit.points,
      northLimit: categories.northLimit.points
    };

    // Send to Google Sheets via Apps Script
    fetch("https://script.google.com/macros/s/AKfycbzdL3pesPI-rotFSxgmT1k06AASBEskksMvzqTh9b7gosBLxtpEuFzKWa0bXc_JFILl/exec", {
      method: "POST",
      mode: "no-cors", // avoid CORS issues
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(() => {
      alert("Survey submitted successfully!");
      // Optionally clear map and reset form
    })
    .catch(err => {
      console.error("Error:", err);
      alert("Submission failed. Check console.");
    });
  };
</script>
</body>
</html>
